<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ptLasso">
<title>Different groups in train and test data • ptLasso</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Different groups in train and test data">
<meta property="og:description" content="ptLasso">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ptLasso</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/ptLasso.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/DifferentGroupsTrainAndTest.html">Different groups in train and test data</a>
    <a class="dropdown-item" href="../articles/LearningTheInputGroups.html">Learning the input groups</a>
    <a class="dropdown-item" href="../articles/MultitaskLearning.html">Multitask learning or coaching</a>
    <a class="dropdown-item" href="../articles/MultiResponseData.html">Multi-response data with mixed response types</a>
    <a class="dropdown-item" href="../articles/TimeSeriesData.html">Time series</a>
    <a class="dropdown-item" href="../articles/UsingNonlinearBases.html">Pretraining with nonlinear bases</a>
    <a class="dropdown-item" href="../articles/UnsupervisedPretraining.html">Unsupervised pretraining</a>
    <a class="dropdown-item" href="../articles/ConditionalAverageTreatmentEffect.html">Conditional average treatment effects</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Different groups in train and test data</h1>
            
      
      
      <div class="d-none name"><code>DifferentGroupsTrainAndTest.Rmd</code></div>
    </div>

    
    
<p>Suppose we observe groups at test time that were unobserved at train
time. For example, our training set may consist of <span class="math inline">\(K\)</span> <em>people</em> – each with many
observations – and at test time, we wish to make predictions for
observations from new people. We can still use pretraining in this
setting: train a model using all data, and use this to guide the
training for person-specific models.</p>
<p>Now however, we also fit an extra model to predict the similarity of
test observations to the observations from each of the <em>training
people</em>. To train this model, we use the (training) observation
matrix <span class="math inline">\(X\)</span> and the response <span class="math inline">\(y_{\text{sim}}\)</span>, where <span class="math inline">\(y_{\text{sim}} = k\)</span> for all observations
from the <span class="math inline">\(k^\text{th}\)</span> person. When
used for prediction, this model gives us a similarity (or probability)
vector of length <span class="math inline">\(K\)</span> that sums to 1,
describing how similar an observation is to each training person.</p>
<p>At test time, we make predictions from (1) each pretrained
person-specific model and (2) the person-similarity model, and we
compute the weighted average of the pretrained predictions with respect
to the similarity vector. Here is an example using simulated data.</p>
<pre><code><span><span class="co">#&gt; Loading required package: glmnet</span></span>
<span><span class="co">#&gt; Loading required package: Matrix</span></span>
<span><span class="co">#&gt; Loaded glmnet 4.1-8</span></span>
<span><span class="co">#&gt; Loading required package: ptLasso</span></span>
<span><span class="co">#&gt; Loading required package: ggplot2</span></span>
<span><span class="co">#&gt; Loading required package: gridExtra</span></span></code></pre>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Start with 5 people, each with 300 observations and 200 features.</span></span>
<span><span class="co"># 3 people will be used for training, and 2 for testing.</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">300</span><span class="op">*</span><span class="fl">5</span>; <span class="va">p</span> <span class="op">=</span> <span class="fl">200</span>;</span>
<span><span class="va">groups</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">n</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We will have different coefficients for each of the 3 training people, </span></span>
<span><span class="co"># and the first 3 features are shared support.</span></span>
<span><span class="va">beta.group1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p</span><span class="op">-</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span>; </span>
<span><span class="va">beta.group2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p</span><span class="op">-</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span>; </span>
<span><span class="va">beta.group3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p</span><span class="op">-</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span>; </span>
<span></span>
<span><span class="co"># The two test people are each a combination of of the training people.</span></span>
<span><span class="co"># Person 4 will have observations drawn from classes 1 and 2, and</span></span>
<span><span class="co"># Person 5 will have observations drawn from classes 1 and 3.</span></span>
<span><span class="co"># The vector "hidden groups" is a latent variable - used to simulate data</span></span>
<span><span class="co"># but unobserved in real data.</span></span>
<span><span class="va">hidden.gps</span> <span class="op">=</span> <span class="va">groups</span></span>
<span><span class="va">hidden.gps</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">4</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">groups</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">hidden.gps</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">5</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">groups</span> <span class="op">==</span> <span class="fl">5</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We modify X according to group membership;</span></span>
<span><span class="co"># we want X to cluster into groups 1, 2 and 3.</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">3</span></span>
<span></span>
<span><span class="co"># And now, we compute y using betas 1, 2 and 3: </span></span>
<span><span class="va">x.beta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x.beta</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta.group1</span> </span>
<span><span class="va">x.beta</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">2</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta.group2</span> </span>
<span><span class="va">x.beta</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">3</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">hidden.gps</span> <span class="op">==</span> <span class="fl">3</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta.group3</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x.beta</span> <span class="op">+</span> <span class="fl">5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></code></pre></div>
<p>We’re ready to split into train, validation and test sets. We will
use people 1, 2 and 3 for training and validation (two-thirds train,
one-third validation), and people 4 and 5 for testing.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trn.index</span> <span class="op">=</span> <span class="va">groups</span> <span class="op">&lt;</span> <span class="fl">4</span></span>
<span><span class="va">val.sample</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">trn.index</span><span class="op">)</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">3</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">trn.index</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xtrain</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">trn.index</span>, <span class="op">]</span><span class="op">[</span><span class="op">-</span><span class="va">val.sample</span>, <span class="op">]</span></span>
<span><span class="va">ytrain</span> <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">trn.index</span><span class="op">]</span><span class="op">[</span><span class="op">-</span><span class="va">val.sample</span><span class="op">]</span></span>
<span><span class="va">gpstrain</span> <span class="op">=</span> <span class="va">groups</span><span class="op">[</span><span class="va">trn.index</span><span class="op">]</span><span class="op">[</span><span class="op">-</span><span class="va">val.sample</span><span class="op">]</span></span>
<span></span>
<span><span class="va">xval</span>   <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">trn.index</span>, <span class="op">]</span><span class="op">[</span><span class="va">val.sample</span>, <span class="op">]</span> </span>
<span><span class="va">yval</span> <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">trn.index</span><span class="op">]</span><span class="op">[</span><span class="va">val.sample</span><span class="op">]</span></span>
<span><span class="va">gpsval</span> <span class="op">=</span> <span class="va">groups</span><span class="op">[</span><span class="va">trn.index</span><span class="op">]</span><span class="op">[</span><span class="va">val.sample</span><span class="op">]</span></span>
<span></span>
<span><span class="va">xtest</span>  <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="va">trn.index</span>, <span class="op">]</span></span>
<span><span class="va">ytest</span> <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="op">!</span><span class="va">trn.index</span><span class="op">]</span></span>
<span><span class="va">gpstest</span> <span class="op">=</span> <span class="va">groups</span><span class="op">[</span><span class="op">!</span><span class="va">trn.index</span><span class="op">]</span></span></code></pre></div>
<p>We start with pretraining, where the person ID is the grouping
variable.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cvfit</span> <span class="op">=</span> <span class="fu"><a href="../reference/cv.ptLasso.html">cv.ptLasso</a></span><span class="op">(</span><span class="va">xtrain</span>, <span class="va">ytrain</span>, <span class="va">gpstrain</span>, </span>
<span>                   type.measure <span class="op">=</span> <span class="st">"mse"</span>, </span>
<span>                   group.intercepts <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                   overall.lambda <span class="op">=</span> <span class="st">"lambda.1se"</span><span class="op">)</span></span></code></pre></div>
<p>Now, we train a model to predict the person ID from the covariates.
Because this example is simulated, we can measure the performance of our
model on test data (via the confusion matrix comparing predicted group
labels to true labels). In real settings, this would be impossible.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simmod</span> <span class="op">=</span> <span class="fu">cv.glmnet</span><span class="op">(</span><span class="va">xtrain</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gpstrain</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"multinomial"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Peek at performance on test data.</span></span>
<span><span class="co"># Not possible with real data.</span></span>
<span><span class="va">class.preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">simmod</span>, <span class="va">xtest</span>, type<span class="op">=</span><span class="st">"response"</span><span class="op">)</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">class.preds</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span>, </span>
<span>      <span class="va">hidden.gps</span><span class="op">[</span><span class="va">groups</span> <span class="op">&gt;=</span> <span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    </span></span>
<span><span class="co">#&gt;       1   2   3</span></span>
<span><span class="co">#&gt;   1 260  37   3</span></span>
<span><span class="co">#&gt;   2  39  82  29</span></span>
<span><span class="co">#&gt;   3   0  36 114</span></span></code></pre></div>
<p>Finally we can make predictions: we have everything we need. For each
test observation, we will get the pretrained prediction for all 3
training classes. Our final predictions are the weighted combination of
the predictions from <code>ptLasso</code> and the class predictions from
<code>glmnet</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alphahat</span>  <span class="op">=</span> <span class="va">cvfit</span><span class="op">$</span><span class="va">alphahat</span></span>
<span><span class="va">bestmodel</span> <span class="op">=</span> <span class="va">cvfit</span><span class="op">$</span><span class="va">fit</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">cvfit</span><span class="op">$</span><span class="va">alphalist</span> <span class="op">==</span> <span class="va">alphahat</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Chosen alpha is"</span>, <span class="va">alphahat</span>, <span class="st">".\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Chosen alpha is 0.5 .</span></span>
<span></span>
<span><span class="va">offset</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">alphahat</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bestmodel</span><span class="op">$</span><span class="va">fitoverall</span>, <span class="va">xtest</span>, s <span class="op">=</span> <span class="st">"lambda.1se"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the prediction for all three classes for each test observation. </span></span>
<span><span class="co"># This will be a matrix with three columns; one for each class.</span></span>
<span><span class="va">pretrained.preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, </span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, </span>
<span>                               <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bestmodel</span><span class="op">$</span><span class="va">fitpre</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                                                   <span class="va">xtest</span>,</span>
<span>                                                   newoffset <span class="op">=</span> <span class="va">offset</span><span class="op">)</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">assess.glmnet</span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">pretrained.preds</span> <span class="op">*</span> <span class="va">class.preds</span><span class="op">)</span>, newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span></span>
<span><span class="co">#&gt; [1] 28.17891</span></span>
<span><span class="co">#&gt; attr(,"measure")</span></span>
<span><span class="co">#&gt; [1] "Mean-Squared Error"</span></span></code></pre></div>
<p>There are two reasonable baselines. The first is the overall model
with no grouping at all, and the second is the set of individual models
(one for each group).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################</span></span>
<span><span class="co"># Baseline 1: overall model</span></span>
<span><span class="co">########################################################</span></span>
<span><span class="va">overall.predictions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">cvfit</span><span class="op">$</span><span class="va">fitoverall</span>, <span class="va">xtest</span><span class="op">)</span></span>
<span><span class="fu">assess.glmnet</span><span class="op">(</span><span class="va">overall.predictions</span>, newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span></span>
<span><span class="co">#&gt; lambda.1se </span></span>
<span><span class="co">#&gt;   29.64747 </span></span>
<span><span class="co">#&gt; attr(,"measure")</span></span>
<span><span class="co">#&gt; [1] "Mean-Squared Error"</span></span>
<span></span>
<span><span class="co">########################################################</span></span>
<span><span class="co"># Baseline 2: individual models</span></span>
<span><span class="co">########################################################</span></span>
<span><span class="va">individual.preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, </span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, </span>
<span>                                  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bestmodel</span><span class="op">$</span><span class="va">fitind</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                                                      <span class="va">xtest</span>,</span>
<span>                                                      type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">assess.glmnet</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">individual.preds</span> <span class="op">*</span> <span class="va">class.preds</span><span class="op">)</span>, newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span></span>
<span><span class="co">#&gt; [1] 29.17333</span></span>
<span><span class="co">#&gt; attr(,"measure")</span></span>
<span><span class="co">#&gt; [1] "Mean-Squared Error"</span></span></code></pre></div>
<p>What we have done – taking a weighted average of predictions with
respect to similarity to each person – makes sense mathematically.
However, we have found better empirical results if we instead train a
supervised learning algorithm to make the final prediction <span class="math inline">\(\hat{y}\)</span> using the pretrained model
predictions and the class similarity predictions as features. So, let’s
do that here, using our so-far-untouched validation set.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">val.offset</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bestmodel</span><span class="op">$</span><span class="va">fitoverall</span>, <span class="va">xval</span>, s <span class="op">=</span> <span class="st">"lambda.1se"</span><span class="op">)</span></span>
<span><span class="va">val.offset</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alphahat</span><span class="op">)</span> <span class="op">*</span> <span class="va">val.offset</span></span>
<span><span class="va">val.preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">bestmodel</span><span class="op">$</span><span class="va">fitpre</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                                                    <span class="va">xval</span>,</span>
<span>                                                    newoffset <span class="op">=</span> <span class="va">val.offset</span>,</span>
<span>                                                    type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">val.class.preds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">simmod</span>, <span class="va">xval</span><span class="op">)</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pred.data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">val.preds</span>, <span class="va">val.class.preds</span>, <span class="va">val.preds</span> <span class="op">*</span> <span class="va">val.class.preds</span><span class="op">)</span> </span>
<span><span class="va">final.model</span> <span class="op">=</span> <span class="fu">cv.glmnet</span><span class="op">(</span><span class="va">pred.data</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">val.preds</span> <span class="op">*</span> <span class="va">val.class.preds</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred.data.test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pretrained.preds</span>, </span>
<span>                       <span class="va">class.preds</span>, </span>
<span>                       <span class="va">pretrained.preds</span> <span class="op">*</span> <span class="va">class.preds</span><span class="op">)</span></span>
<span><span class="fu">assess.glmnet</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">final.model</span>, <span class="va">pred.data.test</span><span class="op">)</span>, newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span></span>
<span><span class="co">#&gt; lambda.1se </span></span>
<span><span class="co">#&gt;   28.28504 </span></span>
<span><span class="co">#&gt; attr(,"measure")</span></span>
<span><span class="co">#&gt; [1] "Mean-Squared Error"</span></span></code></pre></div>
<p>Comparing performance of all models side-by-side shows that (1) using
input groups improved performance – including for the individual models
and (2) including the final model did not help performance (but we still
recommend trying this with real data).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rd</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Overall model PSE: "</span>, </span>
<span>    <span class="fu">rd</span><span class="op">(</span><span class="fu">assess.glmnet</span><span class="op">(</span><span class="va">overall.predictions</span>, newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Overall model PSE:  29.65</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Individual model PSE: "</span>, </span>
<span>    <span class="fu">rd</span><span class="op">(</span><span class="fu">assess.glmnet</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">individual.preds</span><span class="op">*</span><span class="va">class.preds</span><span class="op">)</span>, newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Individual model PSE:  29.17</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Pretraining model PSE: "</span>, </span>
<span>    <span class="fu">rd</span><span class="op">(</span><span class="fu">assess.glmnet</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">pretrained.preds</span><span class="op">*</span><span class="va">class.preds</span><span class="op">)</span>, newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Pretraining model PSE:  28.18</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Pretraining model + final prediction model PSE: "</span>, </span>
<span>    <span class="fu">rd</span><span class="op">(</span><span class="fu">assess.glmnet</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">final.model</span>, </span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pretrained.preds</span>, </span>
<span>                                <span class="va">class.preds</span>, </span>
<span>                                <span class="va">pretrained.preds</span> <span class="op">*</span> <span class="va">class.preds</span><span class="op">)</span></span>
<span>                      <span class="op">)</span>, </span>
<span>              newy <span class="op">=</span> <span class="va">ytest</span><span class="op">)</span><span class="op">$</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Pretraining model + final prediction model PSE:  28.29</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="http://www.erincraig.me" class="external-link">Erin Craig</a>, <a href="http://statistics.stanford.edu/people/robert-tibshirani" class="external-link">Rob Tibshirani</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
